
# ORGANELLE_OS_RasPi

Connettore espansione pisound:
pin 9 (BCM27) -> Led Blu
pin 7 (BCM22) -> Led verde
pin 8 (BCM23) -> led Rosso
Il comune del led va a +5V (viene accesso da pin LOW)

pin 5 (BCM5) -> encoder Button
pin 6 (BCM6) -> encoder DT
pin 3 (BCM7) -> encoder CLK
Il positivo dell'encoder va alimentato a 3.3V

The operating system for the BARBONELLE synthesizer device - remixed for barbons

Il pulsante PiSound e' su GPIO 17 (Pin 11, Wiring Pi pin 0).

########### Installazione da barboni ###########

Scaricare raspbian con lite
PRIMA (e sottolineo il PRIMA) di inzepparlo del raspoberro:

   sudo nano /run/media/io/rootfs/usr/lib/raspi-config/init_resize.h
   cambiare la linea
      ROOT_DEV_SIZE=$(cat "/sys/block/${ROOT_DEV_NAME}/size")
   in
      ROOT_DEV_SIZE=9437184
quindi... procedere. Questo fara' in modo che la partizione root sia di circa 4 gigaspazi.
Una volta che il raspoberro ha resizato a dovere la partizione root, arimettere la sdcard nel PC
e creare una ulteriore partizione ext4 utilizzando tutto lo spazio rimasto nella SD.

sudo raspi-config: 
  1. System Options:
    - configurare WLAN
    - Change password: music
    - Network > Hostname: barbonelle
    - Disable wait for network at boot
  3. Interface Options:
    - abilitare SSH
    - abilirare I2C
  5. Localization Options
.   - Locale: en US UTF8-UTF8
    - Timezone
    - WLAN Country

--- Exit, Reboot
                                     
relogin (attenzione: ora la password Ã¨ music)
sudo apt-get update
sudo apt-get upgrade -y
sudo reboot

creare utente "music":

1  `sudo passwd root`  --> cambiare la password in "root" (!)
2. logout, login as root
Creare user 'music':
  usermod -l music -d /home/music -m pi
  groupmod --new-name music pi

logout, quindi login as music

disable need for passwd with sudo:
sudo passwd -l root
sudo nano /etc/sudoers.d/010_pi-nopasswd
change 'pi' to 'music'
- con raspi-config, abilitare console autologin
poweroff

install git

    apt-get install git

configure

    git config --global user.email "..."
    git config --global user.name "..."

git clone https://github.com/The-XOR/Barbonelle.git ORGANELLE_OS --depth=1
cd ORGANELLE_OS

# install packages 
    
sudo apt-get install -y zip jwm xinit x11-utils x11-xserver-utils lxterminal pcmanfm adwaita-icon-theme gnome-themes-standard gtk-theme-switch conky libasound2-dev liblo-dev liblo-tools mpg123 dnsmasq hostapd
sudo apt-get install -y python3-pip 

# VUENNECI 
  sudo raspi-config
  abilitare VNC

# python stuff 

    pip install Cython
    pip install pyliblo
    pip install cherrypy
       
# install wiringpi
    cd /home/music/ORGANELLE_OS/install
    unzip WiringPi.zip
    cd WiringPi-master
    sudo ./build

sudo apt-get install -y puredata-core luarocks csound supercollider

# instalazione di nodejs

    curl -sL https://deb.nodesource.com/setup_12.x | sudo -E bash -
    sudo apt-get install -y nodejs

# Ora lanciare startx, aprire una finestra bash  e lanciare:
   gtk-theme-switch2 /usr/share/themes/Adwaita

   fix circle icon not showing up in Pd (tcl/tk doesn't like the adwaita circle icon for some reason, so just rename it to force fallback)

    sudo mv /usr/share/icons/Adwaita/cursors/circle /usr/share/icons/Adwaita/cursors/circleORIG


######## E adesso, un po' di amore per il file system.
sudo chmod +xr /root
sudo mkdir /sdcard
sudo chown music:music /sdcard
sudo mkdir /usbdrive
sudo chown music:music /usbdrive

sudo nano /etc/fstab 
aggiungere la linea:
    /dev/mmcblk0p3 /sdcard  ext4 defaults,noatime 0 0

quindi eseguire un reboot
Dopo il reboot, di nuovo:
    sudo chown music:music /sdcard 

systemctl disable hciuart.service
systemctl disable vncserver-x11-serviced.service
systemctl disable hostapd.service

sudo nano /etc/security/limits.conf 

Aggiungere alla fine le linee:

    @music - rtprio 99
    @music - memlock unlimited
    @music - nice -10

sudo nano /etc/systemd/system.conf 

Aggiungere le linee:

    DefaultTimeoutStartSec=10s
    DefaultTimeoutStopSec=5s

dopodiche'
    sudo systemctl daemon-reload
    timedatectl set-ntp false
    sudo apt-get autoremove --purge

# compilazio barbonellis:
   cd ORGANELLE_OS/
   sudo make barbonelle_deploy
    

# update patches
        
    cd /sdcard/
    git clone https://github.com/critterandguitari/Organelle_Patches.git Patches --depth=1
    rm -fr Patches/.git
    rm -f Patches/.gitignore 
    rm -f Patches/README.md 
   

systemctl disable dnsmasq.service
systemctl disable dhcpcd.service
systemctl disable wpa_supplicant.service

######## per rimontare la sdcard in modalita' R/W:
    cd 
    sudo fw_dir/scripts/remount-rw.sh 
 
 